<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>é‡åŠ›ã‚·ãƒŸãƒ¥ãƒ‘ã‚ºãƒ«</title>
<style>
  #board { display: grid; grid-template-columns: repeat(6, 44px); gap: 2px; margin: 20px; user-select: none; }
  .cell { width: 44px; height: 44px; border-radius: 50%; background: #ddd; text-align: center; line-height: 42px; font-size: 19px; cursor: pointer; position: relative;}
  .selected { background: #ffb6c1; }
  .weight { position: absolute; right: 2px; bottom: 2px; font-size: 9px; color: #333;}
</style>
</head>
<body>
<h3>é‡åŠ›ã‚·ãƒŸãƒ¥ãƒ»æ–œã‚è½ã¡</h3>
<div id="board"></div>
<div>ã‚¹ã‚³ã‚¢: <span id="score">0</span></div>
<button onclick="init()">ãƒªã‚»ãƒƒãƒˆ</button>
<script>
const ROWS=8, COLS=6, COLORS=["ğŸ¼","ğŸ¶","ğŸ°","ğŸ¸","ğŸ·"];
let board=[], selected=[], isDragging=false, score=0;

function randomBall() {
  return {
    type: COLORS[Math.floor(Math.random()*COLORS.length)],
    weight: Math.floor(Math.random()*5)+1
  };
}

function drawBoard() {
  const el=document.getElementById('board');
  el.innerHTML='';
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    const ball=board[r][c];
    const cell=document.createElement('div');
    cell.className='cell'+(selected.some(([sr,sc])=>sr===r&&sc===c)?' selected':'');
    if(ball)
      cell.innerHTML=ball.type+'<span class="weight">'+ball.weight+'</span>';
    else
      cell.innerHTML=""; // æ¶ˆãˆãŸã¨ã“ã‚ã¯ç©ºã£ã½
    cell.onmousedown=cell.ontouchstart=(e)=>startDrag(e,r,c);
    cell.onmouseenter=(e)=>dragOver(e,r,c);
    cell.ontouchmove=(e)=>dragTouchMove(e,r,c);
    cell.onmouseup=cell.ontouchend=endDrag;
    el.appendChild(cell);
  }
}

function neighbor(r1,c1,r2,c2) {
  return Math.abs(r1-r2)+Math.abs(c1-c2)===1;
}

function sameType(r,c) {
  if(selected.length===0) return true;
  const [sr,sc]=selected[0];
  return board[sr][sc].type===board[r][c].type;
}

function startDrag(e,r,c) {
  e.preventDefault();
  if(!board[r][c]) return;
  selected=[[r,c]];
  isDragging=true;
  drawBoard();
}

function dragOver(e,r,c) {
  if(!isDragging || !board[r][c]) return;
  // æ—¢ã«é¸æŠæ¸ˆã¿ãªã‚‰ãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚¯è¨±å¯
  if(selected.length>=2 && selected[selected.length-2][0]===r && selected[selected.length-2][1]===c){
    selected.pop();
    drawBoard();
    return;
  }
  // è¿½åŠ 
  const last=selected[selected.length-1];
  if(!selected.some(([sr,sc])=>sr===r&&sc===c) && neighbor(last[0],last[1],r,c) && sameType(r,c)) {
    selected.push([r,c]);
    drawBoard();
  }
}
function dragTouchMove(e){
  let touch = e.touches[0];
  let tar = document.elementFromPoint(touch.clientX, touch.clientY);
  if(!tar) return;
  // cellä½•ç•ªç›®ï¼Ÿ
  const idx = Array.prototype.indexOf.call(document.querySelectorAll('.cell'), tar.closest('.cell'));
  if(idx < 0) return;
  const r=Math.floor(idx/COLS), c=idx%COLS;
  dragOver(e,r,c);
}

// â†“â†“â†“ã“ã“ãŒä¸€ç•ªé‡è¦ï¼ˆæœ¬ç‰©ã®é‡åŠ›ï¼šæ–œã‚ã«ã‚‚è½ã¡ã‚‹ï¼‰â†“â†“â†“
function applyGravity() {
  let moved;
  do {
    moved = false;
    for(let r=ROWS-2;r>=0;r--) {
      for(let c=0;c<COLS;c++) {
        if(board[r][c] && !board[r+1][c]) {
          board[r+1][c]=board[r][c]; board[r][c]=null; moved=true;
        } else if(board[r][c]) {
          // å·¦ä¸‹å„ªå…ˆã§è½ã¡ã‚‹
          if(c>0 && !board[r+1][c-1]) {
            board[r+1][c-1]=board[r][c]; board[r][c]=null; moved=true;
          } else if(c<COLS-1 && !board[r+1][c+1]) {
            board[r+1][c+1]=board[r][c]; board[r][c]=null; moved=true;
          }
        }
      }
    }
  } while(moved);
  // ç©ºç™½ã¯æ–°ã—ã„ç‰ã§åŸ‹ã‚ã‚‹
  for(let r=0;r<ROWS;r++)
    for(let c=0;c<COLS;c++)
      if(!board[r][c]) board[r][c]=randomBall();
}

function endDrag(e){
  if(selected.length>=3){
    let total=0;
    for(const [r,c] of selected){total+=board[r][c].weight;board[r][c]=null;}
    score+=total;
    document.getElementById('score').textContent=score;
    applyGravity();
  }
  selected=[];
  isDragging=false;
  drawBoard();
}

function init(){
  score=0;
  board=Array.from({length:ROWS},()=>Array.from({length:COLS},randomBall));
  selected=[];
  isDragging=false;
  document.getElementById('score').textContent=score;
  drawBoard();
}
init();
// ã‚¹ãƒãƒ›ã‚¤ãƒ™ãƒ³ãƒˆç”¨
document.addEventListener('touchend',endDrag);
</script>
<p>æ¶ˆã—ãŸå¾Œã€ç‰ãŒæ–œã‚ä¸‹ãªã©ã«ã‚‚è»¢ãŒã‚‹ã€Œæœ¬ç‰©ã®é‡åŠ›ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚</p>
</body>
</html>
