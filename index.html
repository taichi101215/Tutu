<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>本物の重力・リアル玉パズル</title>
<style>
  body{ background: #eee; }
  canvas { background: #fff; border: 1px solid #999; display: block; margin: 20px auto;}
</style>
</head>
<body>
<h3>滑らかな重力シミュ（配列なし）</h3>
<canvas id="cv" width="300" height="400"></canvas>
<button onclick="resetBalls()">リセット</button>
<script>
const R = 18;
const W = 300, H = 400, BALL_NUM = 18;
const COLORS = ["#daa", "#aaf", "#ffb", "#aee", "#ecc"];
const emojis = ["🐼","🐶","🐰","🐸","🐷"];
let balls = [];

function resetBalls() {
  balls = [];
  for (let i=0; i<BALL_NUM; i++) {
    balls.push({
      x: Math.random()*(W-2*R)+R,
      y: Math.random()*(H/2-R),
      vx: 0,
      vy: 0,
      color: COLORS[Math.floor(Math.random()*COLORS.length)],
      emoji: emojis[Math.floor(Math.random()*emojis.length)],
      weight: Math.floor(Math.random()*5)+1,
      fixed: false // 静止したか
    });
  }
}
resetBalls();

function overlap(b1, b2) {
  let dx = b1.x - b2.x, dy = b1.y - b2.y;
  return dx*dx + dy*dy < (2*R-1)*(2*R-1);
}

// 物理シミュ,各フレーム
function simulatePhysics() {
  for(let b of balls){
    if (b.fixed) continue;
    b.vy += 0.45; //重力加速度
    b.x += b.vx;
    b.y += b.vy;

    // 床
    if (b.y > H-R) {
      b.y = H-R;
      b.vy *= -0.35;
      if (Math.abs(b.vy) < 1.2) b.vy=0, b.fixed=true;
    }
    // 壁
    if (b.x < R) { b.x=R; b.vx*=-0.4;}
    if (b.x > W-R) { b.x=W-R; b.vx*=-0.4;}
  }
  // 衝突
  for(let i=0;i<balls.length;i++)for(let j=i+1;j<balls.length;j++){
    let b1=balls[i], b2=balls[j];
    let dx = b2.x-b1.x, dy = b2.y-b1.y;
    let dist = Math.sqrt(dx*dx+dy*dy);
    if(dist<2*R-1){
      let ov = 2*R-dist;
      let nx = dx/dist, ny = dy/dist;
      b1.x -= nx*ov/2;
      b1.y -= ny*ov/2;
      b2.x += nx*ov/2;
      b2.y += ny*ov/2;
      // 球同士の力
      let dot = (b2.vx-b1.vx)*nx+(b2.vy-b1.vy)*ny;
      b1.vx += dot*nx*0.2;
      b1.vy += dot*ny*0.2;
      b2.vx -= dot*nx*0.2;
      b2.vy -= dot*ny*0.2;
    }
  }
}

function draw() {
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  ctx.clearRect(0,0,W,H);
  for(let b of balls){
    // 丸
    ctx.beginPath();
    ctx.arc(b.x,b.y,R,0,Math.PI*2);
    ctx.fillStyle = b.color;
    ctx.fill();
    ctx.stroke();
    ctx.font="21px serif";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillStyle="#444";
    ctx.fillText(b.emoji, b.x, b.y);
    ctx.font="11px sans-serif";
    ctx.fillText(b.weight, b.x+R-7, b.y+R-8);
  }
}

// アニメフレーム
function loop() {
  simulatePhysics();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
<p>マス目を使わず、滑らかに重力シミュレーション！</p>
</body>
</html>
