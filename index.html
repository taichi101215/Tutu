<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>é‡ã•ã¤ãã‚¹ãƒ¯ã‚¤ãƒ—ãƒ‘ã‚ºãƒ«</title>
<style>
  #board { display: grid; grid-template-columns: repeat(6, 44px); gap: 2px; margin: 20px; user-select: none; }
  .cell { width: 44px; height: 44px; border-radius: 50%; background: #ddd; text-align: center; line-height: 42px; font-size: 19px; cursor: pointer; position: relative;}
  .selected { background: #ffb6c1; }
  .weight { position: absolute; right: 2px; bottom: 2px; font-size: 9px; color: #333;}
</style>
</head>
<body>
<h3>ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦3ã¤ä»¥ä¸Šç¹‹ã’ã¦æ¶ˆãã†ï¼ï¼ˆç‚¹æ•°ã¯é‡ã•ã®åˆè¨ˆï¼‰</h3>
<div id="board"></div>
<div>ã‚¹ã‚³ã‚¢: <span id="score">0</span></div>
<button onclick="init()">ãƒªã‚»ãƒƒãƒˆ</button>
<script>
const ROWS=8, COLS=6, COLORS=["ğŸ¼","ğŸ¶","ğŸ°","ğŸ¸","ğŸ·"];
let board=[], selected=[], isDragging=false, score=0;

function randomBall() {
  return {
    type: COLORS[Math.floor(Math.random()*COLORS.length)],
    weight: Math.floor(Math.random()*5)+1
  };
}

function drawBoard() {
  const el=document.getElementById('board');
  el.innerHTML='';
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    const ball=board[r][c];
    const cell=document.createElement('div');
    cell.className='cell'+(selected.some(([sr,sc])=>sr===r&&sc===c)?' selected':'');
    cell.innerHTML=ball.type+'<span class="weight">'+ball.weight+'</span>';
    cell.onmousedown=cell.ontouchstart=(e)=>startDrag(e,r,c);
    cell.onmouseenter=(e)=>dragOver(e,r,c);
    cell.ontouchmove=(e)=>dragTouchMove(e,r,c);
    cell.onmouseup=cell.ontouchend=endDrag;
    el.appendChild(cell);
  }
}

function neighbor(r1,c1,r2,c2) {
  return Math.abs(r1-r2)+Math.abs(c1-c2)===1;
}

function sameType(r,c) {
  if(selected.length===0) return true;
  const [sr,sc]=selected[0];
  return board[sr][sc].type===board[r][c].type;
}

function startDrag(e,r,c) {
  e.preventDefault();
  selected=[[r,c]];
  isDragging=true;
  drawBoard();
}

function dragOver(e,r,c) {
  if(!isDragging) return;
  // æ—¢ã«é¸æŠæ¸ˆã¿ãªã‚‰ãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚¯è¨±å¯
  if(selected.length>=2 && selected[selected.length-2][0]===r && selected[selected.length-2][1]===c){
    selected.pop();
    drawBoard();
    return;
  }
  // è¿½åŠ 
  const last=selected[selected.length-1];
  if(!selected.some(([sr,sc])=>sr===r&&sc===c) && neighbor(last[0],last[1],r,c) && sameType(r,c)) {
    selected.push([r,c]);
    drawBoard();
  }
}
function dragTouchMove(e){
  let touch = e.touches[0];
  let tar = document.elementFromPoint(touch.clientX, touch.clientY);
  if(!tar) return;
  // cellä½•ç•ªç›®ï¼Ÿ
  const idx = Array.prototype.indexOf.call(document.querySelectorAll('.cell'), tar.closest('.cell'));
  if(idx < 0) return;
  const r=Math.floor(idx/COLS), c=idx%COLS;
  dragOver(e,r,c);
}

function endDrag(e){
  if(selected.length>=3){
    let total=0;
    for(const [r,c] of selected){total+=board[r][c].weight;board[r][c]=null;}
    score+=total;
    document.getElementById('score').textContent=score;
    // é‡åŠ›ã§è©°ã‚ã‚‹
    for(let c=0;c<COLS;c++){
      let col=board.map(row=>row[c]).filter(v=>v!==null);
      while(col.length<ROWS) col.unshift(randomBall());
      for(let r=0;r<ROWS;r++)board[r][c]=col[r];
    }
  }
  selected=[];
  isDragging=false;
  drawBoard();
}

function init(){
  score=0;
  board=Array.from({length:ROWS},()=>Array.from({length:COLS},randomBall));
  selected=[];
  isDragging=false;
  document.getElementById('score').textContent=score;
  drawBoard();
}
init();
// ã‚¹ãƒãƒ›ã‚¤ãƒ™ãƒ³ãƒˆç”¨
document.addEventListener('touchend',endDrag);
</script>
<p>åŒã˜è‰²ã®ãƒœãƒ¼ãƒ«ã‚’3å€‹ä»¥ä¸Šãªãã‚‹ã¨è‡ªå‹•ã§æ¶ˆãˆã¾ã™ã€‚æ¶ˆã—ãŸãƒœãƒ¼ãƒ«ã®é‡ã•ã®åˆè¨ˆãŒã‚¹ã‚³ã‚¢ã«ãªã‚Šã¾ã™ã€‚</p>
</body>
</html>
