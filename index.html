<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æœ¬ç‰©ã®é‡åŠ›ãƒ»ãƒªã‚¢ãƒ«ç‰ãƒ‘ã‚ºãƒ«</title>
<style>
  body{ background: #eee; }
  canvas { background: #fff; border: 1px solid #999; display: block; margin: 20px auto;}
</style>
</head>
<body>
<h3>æ»‘ã‚‰ã‹ãªé‡åŠ›ã‚·ãƒŸãƒ¥ï¼ˆé…åˆ—ãªã—ï¼‰</h3>
<canvas id="cv" width="300" height="400"></canvas>
<button onclick="resetBalls()">ãƒªã‚»ãƒƒãƒˆ</button>
<script>
const R = 18;
const W = 300, H = 400, BALL_NUM = 18;
const COLORS = ["#daa", "#aaf", "#ffb", "#aee", "#ecc"];
const emojis = ["ğŸ¼","ğŸ¶","ğŸ°","ğŸ¸","ğŸ·"];
let balls = [];

function resetBalls() {
  balls = [];
  for (let i=0; i<BALL_NUM; i++) {
    balls.push({
      x: Math.random()*(W-2*R)+R,
      y: Math.random()*(H/2-R),
      vx: 0,
      vy: 0,
      color: COLORS[Math.floor(Math.random()*COLORS.length)],
      emoji: emojis[Math.floor(Math.random()*emojis.length)],
      weight: Math.floor(Math.random()*5)+1,
      fixed: false // é™æ­¢ã—ãŸã‹
    });
  }
}
resetBalls();

function overlap(b1, b2) {
  let dx = b1.x - b2.x, dy = b1.y - b2.y;
  return dx*dx + dy*dy < (2*R-1)*(2*R-1);
}

// ç‰©ç†ã‚·ãƒŸãƒ¥,å„ãƒ•ãƒ¬ãƒ¼ãƒ 
function simulatePhysics() {
  for(let b of balls){
    if (b.fixed) continue;
    b.vy += 0.45; //é‡åŠ›åŠ é€Ÿåº¦
    b.x += b.vx;
    b.y += b.vy;

    // åºŠ
    if (b.y > H-R) {
      b.y = H-R;
      b.vy *= -0.35;
      if (Math.abs(b.vy) < 1.2) b.vy=0, b.fixed=true;
    }
    // å£
    if (b.x < R) { b.x=R; b.vx*=-0.4;}
    if (b.x > W-R) { b.x=W-R; b.vx*=-0.4;}
  }
  // è¡çª
  for(let i=0;i<balls.length;i++)for(let j=i+1;j<balls.length;j++){
    let b1=balls[i], b2=balls[j];
    let dx = b2.x-b1.x, dy = b2.y-b1.y;
    let dist = Math.sqrt(dx*dx+dy*dy);
    if(dist<2*R-1){
      let ov = 2*R-dist;
      let nx = dx/dist, ny = dy/dist;
      b1.x -= nx*ov/2;
      b1.y -= ny*ov/2;
      b2.x += nx*ov/2;
      b2.y += ny*ov/2;
      // çƒåŒå£«ã®åŠ›
      let dot = (b2.vx-b1.vx)*nx+(b2.vy-b1.vy)*ny;
      b1.vx += dot*nx*0.2;
      b1.vy += dot*ny*0.2;
      b2.vx -= dot*nx*0.2;
      b2.vy -= dot*ny*0.2;
    }
  }
}

function draw() {
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  ctx.clearRect(0,0,W,H);
  for(let b of balls){
    // ä¸¸
    ctx.beginPath();
    ctx.arc(b.x,b.y,R,0,Math.PI*2);
    ctx.fillStyle = b.color;
    ctx.fill();
    ctx.stroke();
    ctx.font="21px serif";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillStyle="#444";
    ctx.fillText(b.emoji, b.x, b.y);
    ctx.font="11px sans-serif";
    ctx.fillText(b.weight, b.x+R-7, b.y+R-8);
  }
}

// ã‚¢ãƒ‹ãƒ¡ãƒ•ãƒ¬ãƒ¼ãƒ 
function loop() {
  simulatePhysics();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
<p>ãƒã‚¹ç›®ã‚’ä½¿ã‚ãšã€æ»‘ã‚‰ã‹ã«é‡åŠ›ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼</p>
</body>
</html>
